<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <style>
      body {
        font-family: 'Segoe UI', 'Helvetica Neue', sans-serif;
        background-color: #f0f2f5;
        color: #333;
        margin: 0;
        padding: 20px;
      }

      .container {
        max-width: 450px;
        margin: auto;
        background: #4CAF50;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        color: white;
      }

      .header {
        background-color: #007bff;
        color: white;
        text-align: center;
        padding: 10px;
        border-radius: 6px 6px 0 0;
        font-size: 1.2em;
        margin: -25px -25px 20px -25px;
      }

      label {
        display: block;
        margin-top: 12px;
        font-weight: bold;
        color: white;
      }

      input, select {
        width: 100%;
        padding: 8px;
        margin-top: 4px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
        background: white;
        color: black;
      }

      button {
        margin-top: 15px;
        padding: 10px;
        width: 100%;
        background-color: #007bff;
        color: white;
        font-weight: bold;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      button:hover {
        background-color: #0056b3;
      }

      #msg {
        margin-top: 12px;
        font-weight: bold;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">Inventory Manager</div>

      <label for="productId">Product ID</label>
      <input id="productId" placeholder="e.g. 10001" onblur="prefill()" />

      <label for="name">Product Name</label>
      <input id="name" placeholder="e.g. Nutella 2 Go" />

      <label for="category">Category</label>
      <select id="category"><option value="">Loading...</option></select>

      <label for="stock">Current Stock</label>
      <input type="number" id="stock" placeholder="e.g. 25" />

      <label for="reorder">Reorder Level</label>
      <input type="number" id="reorder" placeholder="e.g. 10" />

      <label for="restock">Restock Qty</label>
      <input type="number" id="restock" placeholder="e.g. 20" />

      <label for="supplier">Supplier</label>
      <select id="supplier"><option value="">Loading...</option></select>

      <label for="cost">Unit Cost</label>
      <input type="number" id="cost" step="0.01" placeholder="e.g. 0.85" />

      <label for="price">Sale Price</label>
      <input type="number" id="price" step="0.01" placeholder="e.g. 1.50" />

      <button onclick="save()">üíæ Save</button>
      <button onclick="update()">üîÑ Adjust Inventory</button>
      <button onclick="clearForm()">üßπ Clear</button>
      <button onclick="del()">üóëÔ∏è Delete</button>

      <div id="msg"></div>
    </div>

    <script>
      function populateDropdowns() {
        google.script.run.withSuccessHandler(function(data) {
          const catSelect = document.getElementById("category");
          const supSelect = document.getElementById("supplier");

          catSelect.innerHTML = '<option value="">Select Category</option>';
          supSelect.innerHTML = '<option value="">Select Supplier</option>';

          data.categories.forEach(cat => {
            const opt = document.createElement("option");
            opt.value = opt.textContent = cat;
            catSelect.appendChild(opt);
          });

          data.suppliers.forEach(sup => {
            const opt = document.createElement("option");
            opt.value = opt.textContent = sup;
            supSelect.appendChild(opt);
          });
        }).getDropdownOptions();
      }

      function getInput() {
        return {
          productId: document.getElementById("productId").value.trim(),
          name: document.getElementById("name").value,
          category: document.getElementById("category").value,
          stock: +document.getElementById("stock").value,
          reorder: +document.getElementById("reorder").value,
          restock: +document.getElementById("restock").value,
          supplier: document.getElementById("supplier").value,
          cost: +document.getElementById("cost").value,
          price: +document.getElementById("price").value
        };
      }

      function clearForm() {
        document.querySelectorAll("input, select").forEach(input => input.value = "");
        showMessage("");
      }

      function showMessage(text, isError = false) {
        const msg = document.getElementById("msg");
        msg.textContent = text;
        msg.style.color = isError ? "red" : "white";
      }

      function save() {
        const item = getInput();
        if (!item.productId || !item.name) {
          showMessage("Product ID and Name are required", true);
          return;
        }

        google.script.run
          .withSuccessHandler(() => {
            showMessage("‚úÖ Product saved.");
            clearForm();
          })
          .withFailureHandler(err => {
            showMessage("üö´ " + err.message, true);
          })
          .saveInventoryItem(item);
      }

      function update() {
        const item = getInput();
        if (!item.productId) {
          showMessage("Product ID is required for update", true);
          return;
        }

        google.script.run
          .withSuccessHandler(() => {
            showMessage("‚úÖ Inventory updated.");
            clearForm();
          })
          .withFailureHandler(err => {
            showMessage("üö´ " + err.message, true);
          })
          .updateInventoryItem(item);
      }

      function del() {
        const pid = document.getElementById("productId").value.trim();
        if (pid) {
          google.script.run.withSuccessHandler(() => {
            showMessage("üóëÔ∏è Deleted successfully");
            clearForm();
          }).deleteInventoryItem(pid);
        } else {
          showMessage("Please enter a Product ID to delete", true);
        }
      }

      function prefill() {
        const pid = document.getElementById("productId").value.trim();
        if (!pid) return;

        google.script.run.withSuccessHandler(function(response) {
          if (response.found) {
            const item = response.item;
            document.getElementById("name").value = item.name;
            document.getElementById("category").value = item.category;
            document.getElementById("stock").value = item.stock;
            document.getElementById("reorder").value = item.reorder;
            document.getElementById("restock").value = item.restock;
            document.getElementById("supplier").value = item.supplier;
            document.getElementById("cost").value = item.cost;
            document.getElementById("price").value = item.price;
            showMessage("‚ÑπÔ∏è Loaded product details.");
          }
        }).getProductById(pid);
      }

      window.onload = populateDropdowns;
    </script>

    <!-- ‚úÖ Register service worker for PWA support -->
    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('https://firstmic79.github.io/inventory-pwa/service-worker.js')
          .then(reg => console.log('‚úÖ Service worker registered.'))
          .catch(err => console.error('‚ö†Ô∏è Service worker registration failed:', err));
      }
    </script>
  </body>
</html>
